<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist Online (Google Sheets)</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --success: #16a34a; --text: #334155; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg); min-height: 100vh; color: var(--text); font-size: 15px; }

        /* LOADING OVERLAY */
        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8);
            display:none; justify-content:center; align-items:center; z-index: 2000; font-weight:bold; color: var(--primary);
        }

        /* LOGIN */
        .login-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; }
        .btn-login { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; }

        /* APP UI */
        .dashboard { max-width: 800px; margin: 0 auto; padding: 15px; display: none; }
        .header { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .card { background: white; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-title { padding: 15px; background: #eff6ff; border-bottom: 1px solid #e2e8f0; font-weight: bold; color: #1e40af; display: flex; justify-content: space-between; }
        
        .task-item { padding: 15px; border-bottom: 1px solid #f1f5f9; }
        .task-main { display: flex; align-items: flex-start; gap: 12px; }
        .task-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-left: 32px; }
        
        .inp-note { flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; margin-right: 10px; }
        .btn-send { padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; }
        .btn-send:disabled { background: #94a3b8; }
        .status-sent { color: var(--success); font-weight: 600; background: #dcfce7; padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; }
        
        /* Admin View */
        .monitor-row { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .monitor-row.done { background: #f0fdf4; }

        /* Sync Button */
        .btn-sync { background: #e2e8f0; border:none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="loader">‚òÅÔ∏è ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</div>

    <div id="loginScreen" class="login-wrap">
        <div class="login-box">
            <h2 style="text-align:center; margin-bottom:20px;">‚òÅÔ∏è Check-list Online</h2>
            <input type="text" id="uName" class="form-input" placeholder="admin, nam_np, nu_np...">
            <input type="password" id="pWord" class="form-input" value="123">
            <button class="btn-login" onclick="login()">ƒêƒÉng Nh·∫≠p</button>
        </div>
    </div>

    <div id="dashboard" class="dashboard">
        <div class="header">
            <div>
                <div style="font-weight:bold" id="uiName">User</div>
                <div style="font-size:0.8rem; color:#666" id="uiRole">...</div>
            </div>
            <div style="display: flex; gap: 5px; align-items: center;">
                <button class="btn-sync" onclick="syncData(true)">üîÑ L√†m m·ªõi</button>
                <button onclick="location.reload()" style="padding:5px 10px; border:1px solid #ccc; border-radius:5px;">Tho√°t</button>
            </div>
        </div>
        <div id="lastUpdateTxt" style="text-align: center; font-size: 0.8rem; color: #999; margin-bottom: 10px;"></div>
        <div id="contentArea"></div>
    </div>

    <script>
        // --- QUAN TR·ªåNG: D√ÅN LINK GOOGLE APPS SCRIPT V√ÄO D∆Ø·ªöI ƒê√ÇY ---
        const API_URL = "https://script.google.com/macros/s/AKfycbyjFnYWoSyJwZtbe3Mhnnf9F0Fl7fwa295IVpxM32G3Q4bR9jYPwXQBc7sc1N1vOzzYHg/exec"; 
        // V√≠ d·ª•: const API_URL = "https://script.google.com/macros/s/AKfycbx.../exec";

        const CHECKLISTS = {
            nam_np: { title: "Khu Nh√† Phao (Nam)", tasks: [
                {t:"15:30", d:"Check-in, D·ªçn xe"}, {t:"16:00", d:"D√°n ·ªëng, b∆°m, g·ª° b·∫°t"}, {t:"16:00", d:"D·ªçn h·ªì c√°, b∆°m n∆∞·ªõc"},
                {t:"Khi ƒë·∫ßy", d:"Lau nh√† h∆°i"}, {t:"17:30", d:"Treo ƒë√®n"}, {t:"18:30", d:"Nh·∫∑t r√°c"},
                {t:"20:00", d:"X·∫£ nh√† phao, g·∫•p b·∫°t"}, {t:"Cu·ªëi ca", d:"B√°o s·ªë n∆∞·ªõc", input:true},
                {t:"Cu·ªëi ca", d:"T·∫Øt ƒë√®n, r√∫t ƒëi·ªán"}, {t:"21:00", d:"Check-out", input:true}
            ]},
            nu_np: { title: "Khu Nh√† Phao (N·ªØ)", tasks: [
                {t:"15:30", d:"Check-in, Ph·ª• d·ªçn"}, {t:"ƒê·∫ßu ca", d:"Ki·ªÉm k√™ n∆∞·ªõc ƒë·∫ßu ca", input:true},
                {t:"18:00", d:"ƒê·ªët nhang mu·ªói"}, {t:"18:30", d:"Nh·∫∑t r√°c"}, {t:"20:00", d:"D·ªçn d·∫πp, k√©o b·∫°t"},
                {t:"Cu·ªëi ca", d:"Ki·ªÉm k√™ n∆∞·ªõc cu·ªëi ca", input:true}, {t:"Cu·ªëi ca", d:"S·∫°c ƒë√®n"}, {t:"21:00", d:"Check-out"}
            ]},
            nam_xd: { title: "Khu Xe ƒêi·ªán (Nam)", tasks: [
                {t:"15:30", d:"Check-in, D·ªçn xe"}, {t:"Chi·ªÅu", d:"GiƒÉng d√¢y, nh·∫°c"}, {t:"T·ªëi", d:"B·∫≠t ƒë√®n"},
                {t:"18:00", d:"ƒê·ªët nhang mu·ªói"}, {t:"18:30", d:"Nh·∫∑t r√°c"}, {t:"20:00", d:"D·ªçn xe v·ªÅ kho"},
                {t:"Cu·ªëi ca", d:"S·∫°c Pin"}, {t:"21:00", d:"Check-out"}
            ]},
            nu_xd: { title: "Khu Xe ƒêi·ªán (N·ªØ)", tasks: [
                {t:"16:00", d:"Check-in, Lau xe"}, {t:"ƒê·∫ßu ca", d:"B√°o v√≤ng tay + N∆∞·ªõc", input:true},
                {t:"18:00", d:"ƒê·ªët nhang mu·ªói"}, {t:"18:30", d:"Nh·∫∑t r√°c"}, {t:"20:00", d:"D·ªçn xe"},
                {t:"Cu·ªëi ca", d:"B√°o v√≤ng tay + N∆∞·ªõc", input:true}, {t:"Cu·ªëi ca", d:"S·∫°c pin"}, {t:"21:00", d:"Check-out"}
            ]}
        };
        const USERS = {
            admin: { name: "Qu·∫£n L√Ω", role: "admin" },
            nam_np: { name: "Nam Nh√† Phao", role: "nam_np" }, nu_np: { name: "N·ªØ Nh√† Phao", role: "nu_np" },
            nam_xd: { name: "Nam Xe ƒêi·ªán", role: "nam_xd" }, nu_xd: { name: "N·ªØ Xe ƒêi·ªán", role: "nu_xd" }
        };

        let currentUser = null;
        let globalData = {}; // Ch·ª©a d·ªØ li·ªáu t·∫£i v·ªÅ t·ª´ Google Sheet

        function login() {
            const u = document.getElementById('uName').value.trim();
            const p = document.getElementById('pWord').value;
            if(USERS[u] && p==='123') {
                if(API_URL.includes("D√ÅN_LINK")) { alert("‚ö†Ô∏è B·∫°n ch∆∞a d√°n link Google Apps Script v√†o code!"); return; }
                currentUser = USERS[u];
                currentUser.username = u;
                document.getElementById('loginScreen').style.display='none';
                document.getElementById('dashboard').style.display='block';
                document.getElementById('uiName').innerText = currentUser.name;
                document.getElementById('uiRole').innerText = currentUser.role;
                syncData(true); // T·∫£i d·ªØ li·ªáu ngay khi ƒëƒÉng nh·∫≠p
            } else { alert("Sai th√¥ng tin!"); }
        }

        // --- K·∫æT N·ªêI GOOGLE SHEETS ---
        async function syncData(showLoading) {
            if(showLoading) document.getElementById('loader').style.display = 'flex';
            
            try {
                const res = await fetch(API_URL); // GET Request ƒë·ªÉ l·∫•y data
                const json = await res.json();
                globalData = json; 
                
                document.getElementById('lastUpdateTxt').innerText = "C·∫≠p nh·∫≠t: " + new Date().toLocaleTimeString();
                renderView();
            } catch(err) {
                console.error(err);
                alert("L·ªói k·∫øt n·ªëi m·∫°ng ho·∫∑c Link API sai!");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function sendDataToCloud(taskIndex, valStr, isDone) {
            document.getElementById('loader').style.display = 'flex';
            
            // 1. L·∫•y d·ªØ li·ªáu hi·ªán t·∫°i c·ªßa Role n√†y
            let myRoleData = globalData[currentUser.role] || {};
            
            // 2. C·∫≠p nh·∫≠t m·ª•c v·ª´a s·ª≠a
            if(!myRoleData[taskIndex]) myRoleData[taskIndex] = {};
            myRoleData[taskIndex] = {
                done: isDone,
                val: valStr,
                sent: true,
                time: new Date().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'})
            };

            // 3. G·ª≠i l√™n Cloud (POST)
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Quan tr·ªçng v·ªõi Apps Script
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: currentUser.role, data: myRoleData })
                });
                
                // 4. L√†m m·ªõi l·∫°i d·ªØ li·ªáu
                await syncData(false);
                
            } catch(err) {
                alert("L·ªói khi g·ª≠i: " + err);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderView() {
            const area = document.getElementById('contentArea');
            area.innerHTML = '';
            
            if(currentUser.role === 'admin') {
                renderAdmin(area);
            } else {
                renderStaff(area);
            }
        }

        function renderStaff(container) {
            const tasks = CHECKLISTS[currentUser.role].tasks;
            const myData = globalData[currentUser.role] || {}; // D·ªØ li·ªáu t·ª´ cloud

            let html = `<div class="card"><div class="card-title">üìù Vi·ªác c·∫ßn l√†m h√¥m nay</div><div>`;
            
            tasks.forEach((task, idx) => {
                const item = myData[idx] || {};
                const isSent = item.sent === true;
                
                html += `
                <div class="task-item" style="${isSent ? 'background:#f0fdf4' : ''}">
                    <div class="task-main">
                        <input type="checkbox" id="chk_${idx}" ${item.done?'checked':''} ${isSent?'disabled':''}>
                        <div style="flex:1">
                            <span style="color:#2563eb; font-weight:bold">${task.t}</span> ${task.d}
                        </div>
                    </div>
                    <div class="task-footer">
                        ${task.input ? `<input type="text" id="inp_${idx}" class="inp-note" value="${item.val||''}" placeholder="Nh·∫≠p s·ªë..." ${isSent?'disabled':''}>` : '<div style="flex:1"></div>'}
                        
                        ${isSent 
                            ? `<span class="status-sent">‚úÖ ƒê√£ g·ª≠i ${item.time}</span>` 
                            : `<button class="btn-send" onclick="handleSend(${idx}, ${task.input?true:false})">‚û§ G·ª≠i</button>`
                        }
                    </div>
                </div>`;
            });
            html += `</div></div>`;
            container.innerHTML = html;
        }

        function handleSend(idx, hasInput) {
            const isDone = document.getElementById(`chk_${idx}`).checked;
            const val = hasInput ? document.getElementById(`inp_${idx}`).value : "";
            
            if(!isDone && !val) {
                if(!confirm("Ch∆∞a t√≠ch ho·∫∑c ch∆∞a nh·∫≠p li·ªáu. G·ª≠i lu√¥n?")) return;
            }
            sendDataToCloud(idx, val, isDone);
        }

        function renderAdmin(container) {
            const roles = ['nam_np', 'nu_np', 'nam_xd', 'nu_xd'];
            let html = `<div style="display:grid; gap:15px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">`;
            
            roles.forEach(r => {
                const roleTitle = CHECKLISTS[r].title;
                const tasks = CHECKLISTS[r].tasks;
                const roleData = globalData[r] || {};
                
                // T√≠nh %
                let count = 0;
                Object.values(roleData).forEach(i => { if(i.sent) count++ });
                const pct = Math.round((count/tasks.length)*100);
                
                html += `
                <div class="card">
                    <div class="card-title">
                        <span>${roleTitle}</span>
                        <span style="font-size:0.8rem; background:#fff; color:#333; padding:2px 6px; border-radius:4px">${pct}%</span>
                    </div>
                    <div style="height:4px; background:#eee; width:100%"><div style="height:100%; background:${pct==100?'green':'blue'}; width:${pct}%"></div></div>
                    <div style="max-height:250px; overflow-y:auto">`;
                    
                tasks.forEach((t, i) => {
                    const item = roleData[i] || {};
                    if(item.sent) {
                        html += `<div class="monitor-row done">
                            <div><b style="color:green">‚úì</b> ${t.t} ${item.val ? `(SL: <b>${item.val}</b>)` : ''}</div>
                            <div style="font-size:0.75rem; color:#666">${item.time}</div>
                        </div>`;
                    } else {
                        html += `<div class="monitor-row" style="opacity:0.5"><div>‚óØ ${t.t}</div></div>`;
                    }
                });
                html += `</div></div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // T·ª± ƒë·ªông ƒë·ªìng b·ªô m·ªói 10 gi√¢y cho Admin
        setInterval(() => {
            if(currentUser && currentUser.role === 'admin') syncData(false);
        }, 10000);
        
        // Cho ph√©p enter ƒëƒÉng nh·∫≠p
        document.getElementById('pWord').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>
