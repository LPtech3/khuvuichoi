<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist T·ª´ng Vi·ªác (Real-time)</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --success: #16a34a;
            --text: #334155;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg); min-height: 100vh; color: var(--text); font-size: 15px; }

        /* LOGIN */
        .login-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
        }
        .form-input {
            width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 15px;
        }
        .btn-login {
            width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
        }

        /* MAIN UI */
        .dashboard { max-width: 800px; margin: 0 auto; padding: 15px; display: none; }
        .header {
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* TASK ITEM STYLES */
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
        .card-title { padding: 15px; background: #eff6ff; border-bottom: 1px solid var(--border); font-weight: bold; color: #1e40af; }
        
        .task-item {
            padding: 15px; border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px;
        }
        .task-item:last-child { border-bottom: none; }
        
        .task-main { display: flex; align-items: flex-start; gap: 12px; }
        .task-chk { width: 20px; height: 20px; margin-top: 2px; cursor: pointer; }
        .task-content { flex: 1; }
        .task-time { color: var(--primary); font-weight: 700; font-size: 0.9rem; margin-right: 5px; }
        
        .task-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 5px; padding-left: 32px; /* align with text */
        }
        
        .inp-note {
            flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; margin-right: 10px;
        }

        /* BUTTONS */
        .btn-send {
            padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; 
            cursor: pointer; font-size: 0.85rem; white-space: nowrap; transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .btn-send:hover { background: #1d4ed8; }
        .btn-send:disabled { background: #94a3b8; cursor: not-allowed; }

        .status-sent {
            color: var(--success); font-weight: 600; font-size: 0.85rem;
            background: #dcfce7; padding: 5px 10px; border-radius: 20px;
            display: flex; align-items: center; gap: 5px;
        }

        /* ADMIN MONITOR */
        .monitor-row {
            padding: 10px 15px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;
        }
        .monitor-row.done { background: #f0fdf4; }
        .monitor-time { font-size: 0.8rem; color: #64748b; }

    </style>
</head>
<body>

    <div id="loginScreen" class="login-wrap">
        <div class="login-box">
            <h2 style="text-align:center; margin-bottom:20px; color:#1e293b;">üîê ƒêƒÉng Nh·∫≠p</h2>
            <input type="text" id="uName" class="form-input" placeholder="Username (admin, nam_np, nu_xd...)">
            <input type="password" id="pWord" class="form-input" placeholder="Password" value="123">
            <button class="btn-login" onclick="login()">V√†o H·ªá Th·ªëng</button>
            <div style="margin-top:15px; font-size:12px; color:#666; text-align:center">
                TK: admin, nam_np, nu_np, nam_xd, nu_xd (Pass: 123)
            </div>
        </div>
    </div>

    <div id="dashboard" class="dashboard">
        <div class="header">
            <div>
                <div style="font-weight:bold; font-size:1.1rem;" id="uiName">User</div>
                <div style="font-size:0.85rem; color:#64748b;" id="uiRole">Role</div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="date" id="datePicker" style="padding:5px; border:1px solid #ccc; border-radius:5px;" onchange="changeDate()">
                <button onclick="logout()" style="padding:6px 12px; border:1px solid #ddd; background:white; border-radius:5px; cursor:pointer">Tho√°t</button>
            </div>
        </div>

        <div id="contentArea"></div>
    </div>

    <script>
        // --- DATA ---
        const CHECKLISTS = {
            nam_np: {
                title: "Khu Nh√† Phao (Nam)",
                tasks: [
                    { t:"15:30", d:"C√≥ m·∫∑t, Check-in, D·ªçn xe" },
                    { t:"16:00", d:"D√°n ·ªëng, n·ªëi b∆°m, g·ª° b·∫°t nh√† phao" },
                    { t:"16:00", d:"D·ªçn h·ªì c√°, b∆°m n∆∞·ªõc, th·∫£ c√°" },
                    { t:"Khi ƒë·∫ßy", d:"Lau nh√† h∆°i (∆∞·ªõt -> kh√¥)" },
                    { t:"17:30", d:"Treo ƒë√®n nh√† phao + h·ªì c√°" },
                    { t:"18:30", d:"Nh·∫∑t r√°c xung quanh (gi·ªØ th√πng ti·ªÅn)" },
                    { t:"20:00", d:"X·∫£ nh√† phao, g·∫•p b·∫°t, d·ªçn h·ªì c√°" },
                    { t:"Cu·ªëi ca", d:"Ch·ª•p s·ªë n∆∞·ªõc b√°o Group", input: true },
                    { t:"Cu·ªëi ca", d:"T·∫Øt ƒë√®n, r√∫t ƒëi·ªán, ph·ª• xe ƒëi·ªán" },
                    { t:"21:00", d:"Check-out (Ch·ª•p ƒë·ªìng h·ªì n∆∞·ªõc)", input: true }
                ]
            },
            nu_np: {
                title: "Khu Nh√† Phao (N·ªØ)",
                tasks: [
                    { t:"15:30", d:"C√≥ m·∫∑t, Check-in, Ph·ª• d·ªçn" },
                    { t:"ƒê·∫ßu ca", d:"Nh·∫∑t r√°c, Ki·ªÉm k√™ n∆∞·ªõc ƒë·∫ßu ca", input: true },
                    { t:"18:00", d:"ƒê·ªët nhang mu·ªói" },
                    { t:"18:30", d:"Nh·∫∑t r√°c, gi·ªØ th√πng ti·ªÅn" },
                    { t:"20:00", d:"D·ªçn d·∫πp, k√©o b·∫°t, nh·∫∑t r√°c" },
                    { t:"Cu·ªëi ca", d:"Ki·ªÉm k√™ n∆∞·ªõc cu·ªëi ca", input: true },
                    { t:"Cu·ªëi ca", d:"S·∫°c ƒë√®n, b·ªô ƒë√†m" },
                    { t:"21:00", d:"Check-out" }
                ]
            },
            nam_xd: {
                title: "Khu Xe ƒêi·ªán (Nam)",
                tasks: [
                    { t:"15:30", d:"Check-in, D·ªçn xe ra (tr∆∞·ªõc 16:30)" },
                    { t:"Chi·ªÅu", d:"ƒê·∫∑t c·ªçc ph√¢n lu·ªìng, giƒÉng d√¢y, nh·∫°c" },
                    { t:"T·ªëi", d:"B·∫≠t ƒë√®n trung t√¢m" },
                    { t:"18:00", d:"ƒê·ªët nhang mu·ªói" },
                    { t:"18:30", d:"Nh·∫∑t r√°c, gi·ªØ th√πng ti·ªÅn" },
                    { t:"20:00", d:"D·ªçn xe, d·ªçn b·∫°t v·ªÅ kho" },
                    { t:"Cu·ªëi ca", d:"S·∫°c Pin xe, loa, b·ªô ƒë√†m" },
                    { t:"21:00", d:"Check-out, tr√πm xe" }
                ]
            },
            nu_xd: {
                title: "Khu Xe ƒêi·ªán (N·ªØ)",
                tasks: [
                    { t:"16:00", d:"Check-in, Ph·ª• d·ªçn, Lau xe" },
                    { t:"ƒê·∫ßu ca", d:"Ki·ªÉm ti·ªÅn l·∫ª, m√°y in, b·ªô ƒë√†m" },
                    { t:"ƒê·∫ßu ca", d:"B√°o s·ªë v√≤ng tay + N∆∞·ªõc", input: true },
                    { t:"18:00", d:"ƒê·ªët nhang mu·ªói" },
                    { t:"18:30", d:"Nh·∫∑t r√°c, gi·ªØ th√πng ti·ªÅn" },
                    { t:"20:00", d:"D·ªçn xe v·ªÅ kho" },
                    { t:"Cu·ªëi ca", d:"B√°o s·ªë v√≤ng tay + N∆∞·ªõc cu·ªëi ca", input: true },
                    { t:"Cu·ªëi ca", d:"S·∫°c pin c√°c thi·∫øt b·ªã" },
                    { t:"21:00", d:"Check-out" }
                ]
            }
        };

        const USERS = {
            admin: { name: "Qu·∫£n L√Ω", role: "admin" },
            nam_np: { name: "Nh√¢n Vi√™n Nam", role: "nam_np" },
            nu_np: { name: "Nh√¢n Vi√™n N·ªØ", role: "nu_np" },
            nam_xd: { name: "Nh√¢n Vi√™n Nam", role: "nam_xd" },
            nu_xd: { name: "Nh√¢n Vi√™n N·ªØ", role: "nu_xd" }
        };

        let currentUser = null;
        let currentDate = new Date().toISOString().split('T')[0];

        // --- CORE FUNCTIONS ---
        function init() {
            document.getElementById('datePicker').value = currentDate;
            // L·∫Øng nghe s·ª± ki·ªán storage ƒë·ªÉ c·∫≠p nh·∫≠t realtime
            window.addEventListener('storage', () => {
                if(currentUser) changeDate(); 
            });
        }

        function login() {
            const u = document.getElementById('uName').value.trim();
            const p = document.getElementById('pWord').value;
            if (USERS[u] && p === '123') {
                currentUser = USERS[u];
                currentUser.username = u;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('uiName').innerText = currentUser.name;
                document.getElementById('uiRole').innerText = CHECKLISTS[currentUser.role]?.title || "Admin Panel";
                changeDate();
            } else {
                alert('Sai th√¥ng tin! Th·ª≠: admin / 123');
            }
        }

        function logout() { location.reload(); }

        function getData(role) {
            const key = `data_${currentDate}_${role}`;
            return JSON.parse(localStorage.getItem(key)) || {};
        }

        function saveData(role, data) {
            localStorage.setItem(`data_${currentDate}_${role}`, JSON.stringify(data));
            // Dispatch event ƒë·ªÉ c√°c tab kh√°c t·ª± c·∫≠p nh·∫≠t
            window.dispatchEvent(new Event('storage'));
        }

        function changeDate() {
            currentDate = document.getElementById('datePicker').value;
            const area = document.getElementById('contentArea');
            area.innerHTML = '';
            
            if (currentUser.role === 'admin') {
                renderAdmin(area);
                if(!window.refreshInt) window.refreshInt = setInterval(changeDate, 3000);
            } else {
                if(window.refreshInt) clearInterval(window.refreshInt);
                renderStaff(area);
            }
        }

        // --- STAFF VIEW ---
        function renderStaff(container) {
            const role = currentUser.role;
            const tasks = CHECKLISTS[role].tasks;
            const savedData = getData(role);

            let html = `<div class="card"><div class="card-title">üìù Danh s√°ch c√¥ng vi·ªác ng√†y ${currentDate}</div><div>`;

            tasks.forEach((task, idx) => {
                const taskData = savedData[idx] || {};
                const isSent = taskData.sent === true;
                
                // N·∫øu ƒë√£ g·ª≠i th√¨ disable
                const disabled = isSent ? 'disabled' : '';
                const bgStyle = isSent ? 'background:#f0fdf4;' : '';

                html += `
                    <div class="task-item" style="${bgStyle}">
                        <div class="task-main">
                            <input type="checkbox" class="task-chk" 
                                ${taskData.done ? 'checked' : ''} ${disabled}
                                onchange="updateTemp(${idx}, 'done', this.checked)">
                            <div class="task-content">
                                <div><span class="task-time">${task.t}</span> ${task.d}</div>
                            </div>
                        </div>
                        
                        <div class="task-footer">
                            ${task.input ? `
                                <input type="text" class="inp-note" placeholder="Nh·∫≠p s·ªë li·ªáu..." 
                                    value="${taskData.val || ''}" ${disabled}
                                    oninput="updateTemp(${idx}, 'val', this.value)">
                            ` : '<div style="flex:1"></div>'}
                            
                            ${isSent 
                                ? `<div class="status-sent">‚úÖ ƒê√£ g·ª≠i l√∫c ${taskData.time}</div>`
                                : `<button class="btn-send" onclick="submitTask(${idx})">‚û§ G·ª≠i</button>`
                            }
                        </div>
                    </div>
                `;
            });
            html += `</div></div>`;
            container.innerHTML = html;
        }

        // C·∫≠p nh·∫≠t t·∫°m th·ªùi (ch∆∞a g·ª≠i)
        function updateTemp(idx, field, value) {
            const data = getData(currentUser.role);
            if (!data[idx]) data[idx] = {};
            data[idx][field] = value;
            // L∆∞u th·∫ßm l·∫∑ng ƒë·ªÉ kh√¥ng m·∫•t d·ªØ li·ªáu n·∫øu f5, nh∆∞ng ch∆∞a t√≠nh l√† "G·ª≠i"
            localStorage.setItem(`data_${currentDate}_${currentUser.role}`, JSON.stringify(data));
        }

        // G·ª≠i ch√≠nh th·ª©c
        function submitTask(idx) {
            // L·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ localStorage (do h√†m updateTemp ƒë√£ l∆∞u)
            const data = getData(currentUser.role);
            if (!data[idx]) data[idx] = {};
            
            // Validate: Nh·∫Øc nh·ªü n·∫øu ch∆∞a check ho·∫∑c ch∆∞a nh·∫≠p
            const currentTaskDef = CHECKLISTS[currentUser.role].tasks[idx];
            if (!data[idx].done && !data[idx].val) {
                if(!confirm("B·∫°n ch∆∞a t√≠ch v√†o √¥ ho·∫∑c ch∆∞a nh·∫≠p li·ªáu. V·∫´n mu·ªën g·ª≠i?")) return;
            }

            // ƒê√°nh d·∫•u ƒë√£ g·ª≠i
            data[idx].sent = true;
            data[idx].time = new Date().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
            
            saveData(currentUser.role, data);
            changeDate(); // Render l·∫°i ƒë·ªÉ hi·ªán n√∫t xanh
        }

        // --- ADMIN VIEW ---
        function renderAdmin(container) {
            const roles = ['nam_np', 'nu_np', 'nam_xd', 'nu_xd'];
            
            let html = `<div style="display:grid; gap:20px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">`;

            roles.forEach(roleKey => {
                const roleTitle = CHECKLISTS[roleKey].title;
                const tasks = CHECKLISTS[roleKey].tasks;
                const data = getData(roleKey);
                
                // T√≠nh ti·∫øn ƒë·ªô
                let sentCount = 0;
                Object.values(data).forEach(d => { if(d.sent) sentCount++; });
                const total = tasks.length;
                const progress = Math.round((sentCount / total) * 100);

                html += `
                    <div class="card">
                        <div class="card-title" style="display:flex; justify-content:space-between;">
                            <span>${roleTitle}</span>
                            <span style="font-size:0.9rem; background:white; padding:2px 8px; border-radius:10px;">${progress}%</span>
                        </div>
                        <div style="height:5px; background:#f1f5f9; width:100%">
                            <div style="height:100%; background:${progress==100 ? '#22c55e' : '#3b82f6'}; width:${progress}%"></div>
                        </div>
                        <div style="max-height:300px; overflow-y:auto;">
                `;

                tasks.forEach((task, idx) => {
                    const item = data[idx] || {};
                    const isSent = item.sent === true;
                    
                    if (isSent) {
                        html += `
                            <div class="monitor-row done">
                                <div>
                                    <div style="font-weight:bold; font-size:0.85rem; color:#15803d">‚úì ${task.t}</div>
                                    <div style="font-size:0.8rem;">${task.d}</div>
                                    ${item.val ? `<div style="color:#d97706; font-weight:bold; font-size:0.85rem">üìù SL: ${item.val}</div>` : ''}
                                </div>
                                <div class="monitor-time">${item.time}</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="monitor-row" style="opacity:0.5">
                                <div style="font-size:0.85rem;">‚óØ ${task.t} - ${task.d}</div>
                            </div>
                        `;
                    }
                });
                html += `</div></div>`;
            });
            html += `</div>`;
            
            html += `<div style="text-align:center; color:#94a3b8; margin-top:20px; font-size:0.8rem">
                D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông theo th·ªùi gian th·ª±c (m·ªói 3 gi√¢y)
            </div>`;

            container.innerHTML = html;
        }

        init();
    </script>
</body>
</html>
